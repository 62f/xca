<?xml version="1.0" encoding="UTF-8"?>

<?include "cpack_variables.wxi"?>

<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi">
	<Product Id="$(var.CPACK_WIX_PRODUCT_GUID)"
             Version="$(var.CPACK_PACKAGE_VERSION)"
             UpgradeCode="$(var.CPACK_WIX_UPGRADE_GUID)"
             Language="1033" Codepage="1252"
             Name="XCA"
             Manufacturer="$(var.CPACK_PACKAGE_VENDOR)" >
        <Package InstallerVersion="300" Compressed="yes" Id="*" Platform="x64"
                 Keywords="Installer" Description="XCA Installer"
                 Languages="1033" SummaryCodepage="1252"
                 Comments="X Certificate and key management"
                 Manufacturer="Christian Hohnstaedt" />

	<MajorUpgrade Schedule="afterInstallInitialize"
                      DowngradeErrorMessage="A later version of [ProductName] is already installed. Setup will now exit."/>

        <Media Id="1" Cabinet="xca.cab" EmbedCab="yes" />
        <!-- https://docs.microsoft.com/de-de/windows/win32/msi/icon-table?redirectedfrom=MSDN -->
        <Icon Id="icon.exe" SourceFile="xca.exe"/>

        <Property Id="ARPPRODUCTICON" Value="icon.exe"/>
        <Property Id="WIXUI_INSTALLDIR" Value="INSTALLDIR" />

        <WixVariable Id="WixUILicenseRtf" Value="$(var.CPACK_WIX_LICENSE_RTF)" />
        <WixVariable Id="WixUIBannerBmp" Value="$(var.CPACK_WIX_UI_BANNER)" />
        <WixVariable Id="WixUIDialogBmp" Value="$(var.CPACK_WIX_UI_DIALOG)" />

        <Directory Id="TARGETDIR" Name="SourceDir">
            <Directory Id="ProgramFiles64Folder">
                <Directory Id="INSTALLDIR" Name="xca" >
                    <Directory Id="platforms" Name="platforms"/>
                    <Directory Id="sqldrivers" Name="sqldrivers"/>
                    <Directory Id="styles" Name="styles"/>
                    <Directory Id="html" Name="html"/>
                    <Directory Id="i18n" Name="i18n"/>
                </Directory>
            </Directory>
            <Directory Id="ProgramMenuFolder">
                <Directory Id="ApplicationProgramsFolder" Name="xca"/>
            </Directory>
        </Directory>

        <DirectoryRef Id="INSTALLDIR">
            <Component Id="Cxca.exe" Guid="af105c5b-0333-4931-819d-ea109af1234b">
                <File Id="xca.exe" Source="xca.exe" KeyPath="yes"/>
                <Shortcut Id="ApplicationStartMenuShortcut"
                          Name="XCA"
                          Description="X Certificate and key management"
                          Target="[#xca.exe]"
                          WorkingDirectory="INSTALLDIR"/>
                <ProgId Id="XCA.Database" Description="XCA Database" Icon="xca.exe">
                    <Extension Id="xdb" ContentType="application/x-xca-database">
                        <Verb Id="open" Command="Open" TargetFile="xca.exe" Argument="&quot;%1&quot;" />
                    </Extension>
                </ProgId>
                <ProgId Id="XCA.Template" Description="XCA Template" Icon="xca.exe">
                    <Extension Id="xca" ContentType="application/x-xca-template">
                        <Verb Id="open" Command="Open" TargetFile="xca.exe" Argument="&quot;%1&quot;" />
                    </Extension>
                </ProgId>
                <ProgId Id="XCA.PEM" Description="Privacy Enhanced Mail" Icon="xca.exe" IconIndex="0">
                    <Extension Id="pem" ContentType="application/x-pem-file">
                        <Verb Id="openwithxca.pem" Command="Open with XCA" TargetFile="xca.exe" Argument="&quot;%1&quot;" />
                    </Extension>
                </ProgId>
                <ProgId Id="XCA.cer" Description="X.509 Certificate" Icon="xca.exe" IconIndex="0">
                    <Extension Id="cer" ContentType="application/pkix-cert">
                        <Verb Id="openwithxca.cer" Command="Open with XCA" TargetFile="xca.exe" Argument="&quot;%1&quot;" />
                    </Extension>
                </ProgId>
                <ProgId Id="XCA.crl" Description="X.509 Certificate Revocation List" Icon="xca.exe" IconIndex="0">
                    <Extension Id="crl" ContentType="application/pkix-crl">
                        <Verb Id="openwithxca.crl" Command="Open with XCA" TargetFile="xca.exe" Argument="&quot;%1&quot;" />
                    </Extension>
                </ProgId>
                <ProgId Id="XCA.crt" Description="X.509 Certificate" Icon="xca.exe" IconIndex="0">
                    <Extension Id="crt" ContentType="application/x-x509-ca-cert">
                        <Verb Id="openwithxca.crt" Command="Open with XCA" TargetFile="xca.exe" Argument="&quot;%1&quot;" />
                    </Extension>
                </ProgId>
                <ProgId Id="XCA.p12" Description="PKCS#12 Certificate and key" Icon="xca.exe" IconIndex="0">
                    <Extension Id="p12" ContentType="application/x-pkcs12">
                        <Verb Id="openwithxca.p12" Command="Open with XCA" TargetFile="xca.exe" Argument="&quot;%1&quot;" />
                    </Extension>
                    <Extension Id="pfx" ContentType="application/x-pkcs12">
                        <Verb Id="openwithxca.pfx" Command="Open with XCA" TargetFile="xca.exe" Argument="&quot;%1&quot;" />
                    </Extension>
                </ProgId>
                <ProgId Id="XCA.p7b" Description="X.509 Certificate" Icon="xca.exe" IconIndex="0">
                    <Extension Id="p7b" ContentType="application/x-pkcs7-certificates">
                        <Verb Id="openwithxca.p7b" Command="Open with XCA" TargetFile="xca.exe" Argument="&quot;%1&quot;" />
                    </Extension>
                </ProgId>
            </Component>
            <Component Id="Clibstdcpp6" Guid="0aae1734-4791-4ac1-818a-911dcdacc80f">
                <File Id="libstdcpp6.dll" Source="libstdc++-6.dll" KeyPath="yes"/>
            </Component>
            <Component Id="Clibwinpthread1" Guid="37453629-c98f-41a9-b060-fe083a1ce903">
                <File Id="libwinpthread1.dll" Source="libwinpthread-1.dll" KeyPath="yes"/>
            </Component>
            <Component Id="Clibgcc_s_seh1" Guid="f5c27ddf-a2e1-49e2-9f24-fbf97bc5cb70">
                <File Id="libgcc_s_seh1.dll" Source="libgcc_s_seh-1.dll" KeyPath="yes"/>
            </Component>
            <Component Id="Clibcrypto11x64" Guid="44133d17-96b5-4aee-8a24-9c722482add5">
                <File Id="libcrypto11x64.dll" Source="libcrypto-1_1-x64.dll" KeyPath="yes"/>
            </Component>
            <Component Id="CQt5Core" Guid="561efd92-0fc8-4e2d-abe8-6ba16fc8bacd">
                <File Id="Qt5Core.dll" Source="Qt5Core.dll" KeyPath="yes"/>
            </Component>
            <Component Id="CQt5Gui" Guid="2f680a70-2b2b-4b6e-9119-f53c8b5e1fe4">
                <File Id="Qt5Gui.dll" Source="Qt5Gui.dll" KeyPath="yes"/>
            </Component>
            <Component Id="CQt5Sql" Guid="df605486-2591-4232-8799-25ad2271e3d4">
                <File Id="Qt5Sql.dll" Source="Qt5Sql.dll" KeyPath="yes"/>
            </Component>
            <Component Id="CQt5Widgets" Guid="eff9bc63-dc01-4f44-ab1f-8447a773817b">
                <File Id="Qt5Widgets.dll" Source="Qt5Widgets.dll" KeyPath="yes"/>
            </Component>
            <Component Id="CQt5Help" Guid="83c15eef-0d1a-43a4-a0f7-1b90d0788705">
                <File Id="Qt5Help.dll" Source="Qt5Help.dll" KeyPath="yes"/>
            </Component>
            <Component Id="Ccopyright.rtf" Guid="83c15eef-0d1a-43a4-a0f7-1b90d0784712">
                <File Id="copyright.rtf" Source="$(var.CPACK_WIX_LICENSE_RTF)" KeyPath="yes"/>
            </Component>

<!--
            <Component Id="Clibpq" Guid="f243d4ea-d51d-42fc-a3c0-4eb186c55d34">
                <File Id="libpq.dll" Source="libpq.dll" KeyPath="yes"/>
            </Component>
                <File Id="libssl11x64.dll" Source="$(var.OPENSSL_INCLUDE_DIR)/../libssl-1_1-x64.dll" KeyPath="yes"/>
            </Component>
        <Component Id="Clibiconv2" Guid="6ef1f17c-8771-4ace-84f0-799d53062ec1">
                <File Id="libiconv2.dll" Source="libiconv-2.dll" KeyPath="yes"/>
            </Component>
            <Component Id="Clibintl8" Guid="64455f86-1d00-4cac-b0ce-f1a8d0f13bce">
                <File Id="libintl8.dll" Source="libintl-8.dll" KeyPath="yes"/>
            </Component>
            <Component Id="Cmsvcp140" Guid="00d0d452-5bd9-41f4-873c-f7e034cc4332">
                <File Id="msvcp140.dll" Source="msvcp140.dll" KeyPath="yes"/>
            </Component>
            <Component Id="Cvcruntime140" Guid="f0b03b2a-14f7-4631-bfe3-d4c6c9b57e1d">
                <File Id="vcruntime140.dll" Source="vcruntime140.dll" KeyPath="yes"/>
            </Component>

            <Component Id="Clibmysql" Guid="9c9d150d-8a36-4cb7-956e-e70258227b3f">
                <File Id="libmysql.dll" Source="libmysql.dll" KeyPath="yes"/>
            </Component>
     -->

            <Component Id="RegistryEntries" Guid="61976812-eb40-4133-8ae0-7956e9e67719">
                <RegistryValue Id="RegInstallDir" Root="HKLM" Key="Software\xca"
                               Name="Install_Dir64" Type="string" Value="[INSTALLDIR]"
                               KeyPath="yes"/>
            </Component>

        </DirectoryRef>

        <DirectoryRef Id="platforms">
            <Component Id="Cqwindows" Guid="7e67d308-14e7-43ad-bb3a-fa4dad3cc1f1">
                <File Id="qwindows.dll" Source="platforms/qwindows.dll" KeyPath="yes"/>
            </Component>
        </DirectoryRef>

        <DirectoryRef Id="sqldrivers">
            <Component Id="Cqsqlite" Guid="6a039415-5278-424a-99b5-fc81b959a829">
                <File Id="qsqlite.dll" Source="sqldrivers/qsqlite.dll" KeyPath="yes"/>
            </Component>
        <!--
            <Component Id="Cqsqlmysql" Guid="4cf3f2cf-8a22-4479-8ed6-24f96e8f9480">
                <File Id="qsqlmysql.dll" Source="sqldrivers/qsqlmysql.dll"/>
            </Component>
            <Component Id="Cqsqlpsql" Guid="526161ae-1023-411e-b7a1-747c93923b31">
                <File Id="qsqlpsql.dll" Source="sqldrivers/qsqlpsql.dll"/>
            </Component>
            -->
            <Component Id="Cqsqlodbc" Guid="c5dca3b3-d6f1-4012-8108-5c7516bd48a9">
                <File Id="qsqlodbc.dll" Source="sqldrivers/qsqlodbc.dll"/>
            </Component>
        </DirectoryRef>

        <DirectoryRef Id="styles">
            <Component Id="Cqwindowsvistastyle" Guid="8e3dfb18-9a16-4b94-a5a5-90d9c4cc0038">
                <File Id="qwindowsvistastyle.dll" Source="styles/qwindowsvistastyle.dll" KeyPath="yes"/>
            </Component>
        </DirectoryRef>

        <DirectoryRef Id="ApplicationProgramsFolder">
            <Component Id="ApplicationUninstall"
                       Guid="ec8d67e2-c5ef-40e1-8bd1-691abaa5e158" KeyPath="no">
                <Shortcut Id="UninstallXCA"
                          Name="Uninstall XCA"
                          Description="Uninstalls XCA"
                          Target="[System64Folder]msiexec.exe"
                          Arguments=" /x [ProductCode]"/>
                <RemoveFolder Id="CleanUpShortCut" Directory="ApplicationProgramsFolder" On="uninstall"/>
                <RegistryValue Root="HKCU" Key="Software\xca" Name="installed" Type="integer" Value="1" KeyPath="yes"/>
            </Component>
        </DirectoryRef>

        <UI>
            <UIRef Id="WixUI_Mondo" />
            <UIRef Id="WixUI_ErrorProgressText" />
            <Publish Dialog="ExitDialog" Control="Finish" Event="DoAction"
                     Value="LaunchApplication">WIXUI_EXITDIALOGOPTIONALCHECKBOX = 1 and NOT Installed</Publish>
        </UI>
	<Property Id="WIXUI_EXITDIALOGOPTIONALTEXT" Value="Enjoy XCA and free Software." />
        <Property Id="WIXUI_EXITDIALOGOPTIONALCHECKBOX" Value="1"/>
        <Property Id="WIXUI_EXITDIALOGOPTIONALCHECKBOXTEXT" Value="Run XCA now" />
        <CustomAction Id="LaunchApplication"
                      ExeCommand="[INSTALLDIR]\xca.exe"
                      Return="asyncNoWait"
                      Directory="INSTALLDIR"
                      Impersonate="yes" />

        <ComponentGroup Id="GroupBasic">
            <ComponentRef Id="Cxca.exe" />
            <ComponentRef Id="Cqwindows" />
            <ComponentRef Id="Cqsqlite" />
            <ComponentRef Id="Cqwindowsvistastyle" />
            <ComponentRef Id="Clibstdcpp6"/>
            <ComponentRef Id="Clibwinpthread1"/>
            <ComponentRef Id="Clibgcc_s_seh1"/>
            <ComponentRef Id="Clibcrypto11x64"/>
            <ComponentRef Id="CQt5Core"/>
            <ComponentRef Id="CQt5Gui"/>
            <ComponentRef Id="CQt5Sql"/>
            <ComponentRef Id="CQt5Widgets"/>
            <ComponentRef Id="CQt5Help"/>
            <ComponentRef Id="Ccopyright.rtf"/>
            <ComponentRef Id="ApplicationUninstall" />
            <ComponentRef Id="RegistryEntries" />
        </ComponentGroup>

        <Feature Id='Complete' Title='XCA' Description="Complete Installation"
                 Display='expand' Level='1' ConfigurableDirectory='INSTALLDIR'>
            <Feature Id="XCA" Title="Main Application" Level="1" Absent="disallow"
                     Description="Contains the main application, required Qt5 libraries and the SQLite driver.">
                <ComponentGroupRef Id="GroupBasic" />
                <ComponentGroupRef Id="GroupI18n" />
                <ComponentGroupRef Id="GroupMisc" />
            </Feature>
            <Feature Id="FileAssociations" Title="File Associations" Level="1"
                     Description="PKI and XCA file associations like .xdb .pem .pfx .crt .crl .p12">
                <ComponentRef Id="Cxca.exe" />
            </Feature>
            <Feature Id="Documentation" Title="Documentation" Level="1"
                     Description="The HTML documentation and changelog file.">
                <ComponentGroupRef Id="GroupDocumentation" />
            </Feature>
            <Feature Id="Databases" Title="Database Drivers"
                     Description="All remote database drivers. The file based SQLite driver will be always installed." Level="1">
                <Feature Id="SqlOdbc" Title="ODBC SQL Driver" Level="1"
                         Description="Access to ODBC databases like Microsoft SQL Server">
                    <ComponentRef Id="Cqsqlodbc" />
                </Feature>
<!--
                <Feature Id="SqlMariaDB" Title="MySQL / MariaDB SQL Driver" Level="100"
                         Description="Native support for MySQL and MariaDB databases. Contains 3rd party DLLs">
                    <ComponentRef Id="Cqsqlmysql" />
                    <ComponentRef Id="Clibmysql" />
                </Feature>
                <Feature Id="SqlPostgres" Title="PostgreSQL Driver" Level="100"
                         Description="Native support for PostgreSQL databases. Contains 3rd party DLLs">
                   <ComponentRef Id="Cqsqlpsql" />
                    <ComponentRef Id="Clibpq" />
                    <ComponentRef Id="Clibssl11x64" />
                    <ComponentRef Id="Clibiconv2" />
                    <ComponentRef Id="Clibintl8" />
                    <ComponentRef Id="Cmsvcp140" />
                    <ComponentRef Id="Cvcruntime140" />
                </Feature>
-->
            </Feature>
        </Feature>
        <?include "properties.wxi"?>

    </Product>
</Wix>
